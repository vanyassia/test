<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —á–∞—Ç‚Äë–±–æ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-page: #f0f2f5;
      --bg-chat: #ffffff;
      --bubble-user: #0b93f6;
      --bubble-bot: #e4e6eb;
      --text-user: #ffffff;
      --text-bot: #050505;
      --accent: #0b93f6;
      --shadow: rgba(0, 0, 0, 0.1);
      --font: 'Inter', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg-page);
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: var(--text-bot);
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg-chat);
      box-shadow: inset 0 0 10px var(--shadow);
    }
    .message {
      display: flex;
      margin: 8px 0;
      align-items: flex-end;
    }
    .message.user { justify-content: flex-end; }
    .message.bot  { justify-content: flex-start; }
    .text {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 20px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }
    .user .text {
      background: var(--bubble-user);
      color: var(--text-user);
      border-bottom-right-radius: 4px;
      border-bottom-left-radius: 20px;
      border-top-right-radius: 20px;
      border-top-left-radius: 20px;
    }
    .bot .text {
      background: var(--bubble-bot);
      color: var(--text-bot);
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 20px;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }
    .text::after {
      content: '';
      position: absolute;
      width: 10px; height: 10px;
      background: inherit;
    }
    .user .text::after {
      right: -5px; bottom: 0;
      border-bottom-right-radius: 4px;
      transform: translateY(-50%) rotate(45deg);
    }
    .bot .text::after {
      left: -5px; bottom: 0;
      border-bottom-left-radius: 4px;
      transform: translateY(-50%) rotate(45deg);
    }
    #inputBar {
      display: flex;
      padding: 12px;
      background: var(--bg-chat);
      box-shadow: 0 -2px 8px var(--shadow);
    }
    #input {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 24px;
      outline: none;
      transition: border-color .2s;
    }
    #input:focus {
      border-color: var(--accent);
    }
    #send {
      margin-left: 12px;
      padding: 0 20px;
      font-size: 16px;
      border: none;
      border-radius: 24px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }
    #send:active {
      transform: scale(0.96);
    }
    table { border-collapse: collapse; }
    button { font: inherit; cursor: pointer; }
    button:hover { opacity: 0.9; }
  </style>
</head>
<body>

  <div id="chat"></div>
  <div id="inputBar">
    <input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" autofocus>
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <!-- Math.js –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');

    let bsField=null, bsShips=null, guessSecret=null;
    const FILMS=["–ú–∞—Ç—Ä–∏—Ü–∞","–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä","–ù–∞—á–∞–ª–æ","–ö—Ä–∏–º–∏–Ω–∞–ª—å–Ω–æ–µ —á—Ç–∏–≤–æ"];
    const BOOKS=["–í–æ–π–Ω–∞ –∏ –º–∏—Ä","–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏—é","–ú–∞—Å—Ç–µ—Ä –∏ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞"];
    const MAGIC_RESP=["–î–∞","–ù–µ—Ç","–í–æ–∑–º–æ–∂–Ω–æ","–°–ø—Ä–æ—Å–∏ –ø–æ–∑–∂–µ","–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ –¥–∞","–í—Ä—è–¥ –ª–∏"];

    function appendMessage(who,text,html=false){
      const m=document.createElement('div');
      m.className=`message ${who}`;
      const b=document.createElement('div');
      b.className='text';
      if(html) b.innerHTML=text;
      else b.textContent=text;
      m.append(b);
      chat.append(m);
      chat.scrollTop = chat.scrollHeight;
    }

    send.addEventListener('click', ()=>handle(input.value));
    input.addEventListener('keypress',e=>e.key==='Enter'&&handle(input.value));

    async function handle(text){
      if(!text.trim())return;
      appendMessage('user',text);
      input.value='';
      const [cmd,...args]=text.trim().split(/\s+/);
      switch(cmd.toLowerCase()){
        case '/calc':        return cmdCalc(args);
        case '/battleship':  return cmdBattleship();
        case '/guess':       return cmdGuessStart();
        case '/currency':    return cmdCurrency(args);
        case '/download':    return cmdDownload();
        case '/askai':       return cmdAskAI(args);
        case '/8ball':       return cmdMagic();
        case '/hello':       return cmdHello(args);
        case '/kiss':        return cmdKiss(args);
        case '/coins':       return cmdCoins();
        case '/fib':         return cmdFib(args);
        case '/guessfilm':   return cmdGuessMedia(FILMS,'—Ñ–∏–ª—å–º');
        case '/guessbook':   return cmdGuessMedia(BOOKS,'–∫–Ω–∏–≥—É');
        case '/grammar':     return cmdGrammar(args);
        case '/base':        return cmdBase(args);
        case '/solve':       return cmdSolve();
        case '/domain':      return cmdDomain();
        case '/spellcheck':  return cmdSpell(args);
        default:
          if(guessSecret!==null && /^\d+$/.test(text)) return cmdGuessAnswer(+text);
          appendMessage('bot','–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /calc, /battleship, /guess, /currency, /8ball –∏ —Ç.–¥.');
      }
    }

    function cmdCalc(a){
      if(!a.length)return appendMessage('bot','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /calc 2+2*3');
      try{ const e=a.join(' '), r=math.evaluate(e); appendMessage('bot',`${e} = ${r}`); }
      catch(e){ appendMessage('bot','–û—à–∏–±–∫–∞: '+e.message); }
    }

    function cmdBattleship(){
      bsField=Array.from({length:5},()=>Array(5).fill('O'));
      bsShips=new Set();
      while(bsShips.size<3) bsShips.add(`${rand(5)},${rand(5)}`);
      renderBS();
    }
    function renderBS(){
      let h='–ú–æ—Ä—Å–∫–æ–π –±–æ–π:<br><table>';
      for(let i=0;i<5;i++){ h+='<tr>'; for(let j=0;j<5;j++){
        h+=`<td><button onclick="clickBS(${i},${j})">${bsField[i][j]}</button></td>`;
      } h+='</tr>'; }
      h+='</table>';
      appendMessage('bot',h,true);
    }
    window.clickBS=(i,j)=>{
      const k=`${i},${j}`;
      if(bsShips.has(k)){ bsField[i][j]='X'; bsShips.delete(k); appendMessage('bot','–ü–æ–ø–∞–¥–∞–Ω–∏–µ!'); }
      else { bsField[i][j]='-'; appendMessage('bot','–ú–∏–º–æ!'); }
      if(bsShips.size===0){ appendMessage('bot','–í—Å–µ –∫–æ—Ä–∞–±–ª–∏ –ø–æ—Ç–æ–ø–ª–µ–Ω—ã! üéâ'); bsField=bsShips=null; }
      renderBS();
    };

    function cmdGuessStart(){ guessSecret=rand(100)+1; appendMessage('bot','–Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100. –£–≥–∞–¥—ã–≤–∞–π!'); }
    function cmdGuessAnswer(n){
      if(n<guessSecret) appendMessage('bot','–ë–æ–ª—å—à–µ!');
      else if(n>guessSecret) appendMessage('bot','–ú–µ–Ω—å—à–µ!');
      else{ appendMessage('bot','–£–≥–∞–¥–∞–ª! üéâ'); guessSecret=null; }
    }

    async function cmdCurrency(a){
      const b=(a[0]||'USD').toUpperCase(), t=(a[1]||'RUB').toUpperCase();
      try{
        const j=await (await fetch(`https://api.exchangerate.host/latest?base=${b}&symbols=${t}`)).json();
        if(j.success) appendMessage('bot',`1 ${b} = ${j.rates[t].toFixed(4)} ${t}`);
        else appendMessage('bot','–û—à–∏–±–∫–∞ API');
      } catch{ appendMessage('bot','–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞'); }
    }

    function cmdDownload(){ appendMessage('bot','/download –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.'); }

    async function cmdAskAI(a){
      if(!a.length) return appendMessage('bot','–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /askai –≤–æ–ø—Ä–æ—Å');
      const k=''; /* –≤–∞—à OpenAI‚Äë–∫–ª—é—á */ 
      if(!k) return appendMessage('bot','–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OPENAI_KEY –≤ –∫–æ–¥–µ.');
      try{
        const res=await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+k},
          body: JSON.stringify({model:'gpt-3.5-turbo',messages:[{role:'user',content:a.join(' ')}]})
        });
        const j=await res.json();
        appendMessage('bot',j.choices?.[0]?.message?.content||'–û—à–∏–±–∫–∞.');
      } catch(e){ appendMessage('bot','–û—à–∏–±–∫–∞ OpenAI'); }
    }

    function cmdMagic(){ appendMessage('bot',MAGIC_RESP[rand(MAGIC_RESP.length)]); }
    function cmdHello(a){ a.length?appendMessage('bot',`üëã –ü—Ä–∏–≤–µ—Ç, ${a[0]}!`):appendMessage('bot','/hello –∏–º—è'); }
    function cmdKiss(a){ a.length?appendMessage('bot',`üòò ${a[0]}, —Ç–µ–±—è —Ü–µ–ª—É—é—Ç!`):appendMessage('bot','/kiss –∏–º—è'); }
    function cmdCoins(){ let c=+localStorage.coins||0, d=rand(10); c+=d; localStorage.coins=c; appendMessage('bot',`–£ –≤–∞—Å ${c} –º–æ–Ω–µ—Ç–æ–∫ (+${d})`); }
    function cmdFib(a){ const n=+a[0]; if(isNaN(n))return appendMessage('bot','/fib n'); let x=0,y=1; for(let i=0;i<n;i++) [x,y]=[y,x+y]; appendMessage('bot',`Fib(${n}) = ${x}`); }
    function cmdGuessMedia(l,w){ const x=l[rand(l.length)]; appendMessage('bot',`–Ø –∑–∞–≥–∞–¥–∞–ª ${w}: <b>${x}</b>`,true); }
    async function cmdGrammar(a){
      const t=a.join(' '); if(!t) return appendMessage('bot','/grammar —Ç–µ–∫—Å—Ç');
      try{
        const p=new URLSearchParams({text:t,language:'ru'});
        const j=await (await fetch('https://api.languagetool.org/v2/check',{method:'POST',body:p})).json();
        if(!j.matches.length) appendMessage('bot','–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        else appendMessage('bot',j.matches.slice(0,3).map(m=>m.message).join('<br>'),true);
      } catch{ appendMessage('bot','–û—à–∏–±–∫–∞ grammar'); }
    }
    function cmdBase(a){
      if(a.length<3) return appendMessage('bot','/base num from to');
      const [num,fr,to]=a, f=+fr, t=+to;
      try{ const d=parseInt(num,f), o=d.toString(t).toUpperCase(); appendMessage('bot',`${num}(base${f}) = ${o}(base${t})`); }
      catch(e){ appendMessage('bot','–û—à–∏–±–∫–∞: '+e.message); }
    }
    function cmdSolve(){ appendMessage('bot','/solve —Ç—Ä–µ–±—É–µ—Ç –±—ç–∫–µ–Ω–¥.'); }
    function cmdDomain(){ appendMessage('bot','/domain —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä.'); }
    async function cmdSpell(a){
      if(!a[0]) return appendMessage('bot','/spellcheck —Å–ª–æ–≤–æ');
      try{
        const p=new URLSearchParams({text:a[0],language:'ru'});
        const j=await (await fetch('https://api.languagetool.org/v2/check',{method:'POST',body:p})).json();
        if(!j.matches.length) appendMessage('bot','–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        else appendMessage('bot',j.matches[0].replacements.map(r=>r.value).slice(0,5).join(', '));
      } catch{ appendMessage('bot','–û—à–∏–±–∫–∞ spellcheck'); }
    }

    function rand(n){ return Math.floor(Math.random()*n); }
  </script>
</body>
</html>
